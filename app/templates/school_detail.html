{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ school.name }} - Details - NECTA Results{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #121212;
        color: #e0e0e0;
    }

    /* Header */
    .school-header {
        background: linear-gradient(135deg, #2c2c54, #40407a);
        color: #f5f6fa;
        padding: 2rem;
        border-radius: 14px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    .school-header h1 {
        color: #dfe6e9;
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.2rem;
        margin: 1.5rem 0;
    }
    .stat-card {
        background: #1e1e2f;
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 2px 12px rgba(0,0,0,0.5);
        transition: transform 0.2s ease-in-out, box-shadow 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.7);
    }
    .stat-number {
        font-size: 1.9rem;
        font-weight: 800;
        color: #74b9ff;
        margin-bottom: 0.5rem;
    }
    .stat-label {
        font-size: 0.85rem;
        color: #b2bec3;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Table */
    .results-table {
        font-size: 0.9rem;
        background: #1c1c28;
        color: #f1f2f6;
    }
    .results-table th {
        background: linear-gradient(135deg, #6c5ce7, #00cec9);
        color: #fff;
    }
    .results-table tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    /* Charts */
    .chart-container {
        background: #1e1e2f;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 18px rgba(0,0,0,0.5);
    }
    .chart-title {
        color: #74b9ff;
        font-size: 1.1rem;
        margin-bottom: 1rem;
        text-align: center;
        font-weight: 600;
    }

    /* Breadcrumb */
    .breadcrumb {
        background: none;
        padding: 0;
        margin-bottom: 1.5rem;
    }
    .breadcrumb a {
        color: #74b9ff;
        text-decoration: none;
    }
    .breadcrumb a:hover {
        text-decoration: underline;
    }

    /* Button */
    .btn-primary {
        background: linear-gradient(135deg, #6c5ce7, #00cec9);
        border: none;
        padding: 0.7rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        box-shadow: 0 3px 10px rgba(0,0,0,0.4);
    }
    .btn-primary:hover {
        opacity: 0.9;
    }

    /* Tabs for exam type filtering */
    .exam-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #343a40;
        padding-bottom: 1rem;
    }
    .exam-tab {
        padding: 0.5rem 1.5rem;
        margin: 0 0.5rem;
        border-radius: 20px;
        background: #2d3436;
        color: #b2bec3;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .exam-tab.active {
        background: linear-gradient(135deg, #6c5ce7, #00cec9);
        color: white;
    }
    .exam-tab:hover:not(.active) {
        background: #3d484a;
    }

    /* Graph tabs */
    .graph-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }
    .graph-tab {
        padding: 0.5rem 1rem;
        margin: 0 0.3rem 0.5rem;
        border-radius: 8px;
        background: #2d3436;
        color: #b2bec3;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }
    .graph-tab.active {
        background: linear-gradient(135deg, #6c5ce7, #00cec9);
        color: white;
    }
    .graph-tab:hover:not(.active) {
        background: #3d484a;
    }

    @media (max-width: 768px) {
        .stat-number { font-size: 1.5rem; }
        .exam-tabs { flex-wrap: wrap; }
        .exam-tab { margin-bottom: 0.5rem; }
        .graph-tabs { flex-wrap: wrap; }
        .graph-tab { margin-bottom: 0.5rem; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'school_rankings' 'ACSEE' 2023 %}">ACSEE 2023 Rankings</a></li>
        <li class="breadcrumb-item active text-light" aria-current="page">{{ school.name }}</li>
    </ol>
</nav>

<!-- School Header -->
<div class="school-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="display-6 fw-bold mb-2">{{ school.name }}</h1>
            <p class="mb-1"><strong>Code:</strong> {{ school.code }}</p>
            <p class="mb-0"><strong>Region:</strong> {{ school.region }}</p>
        </div>
        <div class="col-md-4 text-md-end">
            <span class="badge bg-dark text-light fs-6 shadow-sm">
                <i class="fas fa-clipboard-list me-1"></i>{{ results|length }} Records
            </span>
        </div>
    </div>
</div>

<!-- Exam Type Tabs -->
<div class="exam-tabs">
    <div class="exam-tab active" data-exam="all">All Results</div>
    <div class="exam-tab" data-exam="CSEE">CSEE Results</div>
    <div class="exam-tab" data-exam="ACSEE">ACSEE Results</div>
</div>

<!-- Graph Type Tabs -->
<div class="graph-tabs">
    <div class="graph-tab active" data-graph="gpa">GPA Trends</div>
    <div class="graph-tab" data-graph="division">Division Distribution</div>
    <div class="graph-tab" data-graph="comparison">Performance Comparison</div>
</div>

<!-- GPA Charts -->
<div class="graph-section" id="gpa-section">
    <div class="row">
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">CSEE GPA Trend</div>
                <canvas id="cseeGpaChart" height="250"></canvas>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">ACSEE GPA Trend</div>
                <canvas id="acseeGpaChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Division Charts -->
<div class="graph-section" id="division-section" style="display: none;">
    <div class="row">
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">CSEE Division Distribution</div>
                <canvas id="cseeDivisionChart" height="250"></canvas>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">ACSEE Division Distribution</div>
                <canvas id="acseeDivisionChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Comparison Charts -->
<div class="graph-section" id="comparison-section" style="display: none;">
    <div class="row">
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">CSEE vs ACSEE GPA Comparison</div>
                <canvas id="performanceComparisonChart" height="250"></canvas>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">Division I Comparison</div>
                <canvas id="divisionComparisonChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Exam Results -->
<div class="card bg-dark border-0 shadow-sm mt-3">
    <div class="card-header bg-gradient text-white fw-bold">
        <i class="fas fa-history me-2"></i> Exam Results History
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover results-table mb-0">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Exam Type</th>
                        <th>GPA</th>
                        <th class="text-center">Div I</th>
                        <th class="text-center">Div II</th>
                        <th class="text-center">Div III</th>
                        <th class="text-center">Div IV</th>
                        <th class="text-center">Div 0</th>
                        <th class="text-center">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in results %}
                    <tr class="result-row" data-exam="{{ result.exam }}">
                        <td><strong>{{ result.year }}</strong></td>
                        <td>{{ result.exam }}</td>
                        <td class="fw-bold text-info">{{ result.gpa|floatformat:4 }}</td>
                        <td class="text-center text-success">{{ result.division1 }}</td>
                        <td class="text-center text-primary">{{ result.division2 }}</td>
                        <td class="text-center text-warning">{{ result.division3 }}</td>
                        <td class="text-center text-muted">{{ result.division4 }}</td>
                        <td class="text-center text-danger">{{ result.division0 }}</td>
                        <td class="text-center fw-bold text-light">{{ result.total }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Back Button -->
<div class="text-center mt-4">
    <a href="{% url 'school_rankings' 'ACSEE' 2023 %}" class="btn btn-primary">
        <i class="fas fa-arrow-left me-1"></i> Back to Rankings
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Prepare data for charts
    const cseeResults = [];
    const acseeResults = [];
    
    {% for result in results %}
        {% if result.exam == "CSEE" %}
            cseeResults.push({
                year: '{{ result.year }}',
                gpa: {{ result.gpa }},
                division1: {{ result.division1 }},
                division2: {{ result.division2 }},
                division3: {{ result.division3 }},
                division4: {{ result.division4 }},
                division0: {{ result.division0 }},
                total: {{ result.total }}
            });
        {% elif result.exam == "ACSEE" %}
            acseeResults.push({
                year: '{{ result.year }}',
                gpa: {{ result.gpa }},
                division1: {{ result.division1 }},
                division2: {{ result.division2 }},
                division3: {{ result.division3 }},
                division4: {{ result.division4 }},
                division0: {{ result.division0 }},
                total: {{ result.total }}
            });
        {% endif %}
    {% endfor %}
    
    // Sort results by year
    cseeResults.sort((a, b) => a.year - b.year);
    acseeResults.sort((a, b) => a.year - b.year);
    
    // CSEE GPA Chart
    const cseeGpaCtx = document.getElementById('cseeGpaChart').getContext('2d');
    const cseeGpaChart = new Chart(cseeGpaCtx, {
        type: 'line',
        data: {
            labels: cseeResults.map(result => result.year),
            datasets: [{
                label: 'CSEE GPA',
                data: cseeResults.map(result => result.gpa),
                borderColor: '#74b9ff',
                backgroundColor: 'rgba(116,185,255,0.15)',
                tension: 0.3,
                fill: true,
                pointBackgroundColor: '#0984e3',
                pointBorderColor: '#fff',
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            plugins: {
                legend: { labels: { color: '#ccc' } }
            },
            scales: {
                y: { 
                    reverse: true, 
                    ticks: { color: '#ccc' },
                    title: {
                        display: true,
                        text: 'GPA',
                        color: '#ccc'
                    }
                },
                x: { 
                    ticks: { color: '#ccc' },
                    title: {
                        display: true,
                        text: 'Year',
                        color: '#ccc'
                    }
                }
            }
        }
    });

    // ACSEE GPA Chart
    const acseeGpaCtx = document.getElementById('acseeGpaChart').getContext('2d');
    const acseeGpaChart = new Chart(acseeGpaCtx, {
        type: 'line',
        data: {
            labels: acseeResults.map(result => result.year),
            datasets: [{
                label: 'ACSEE GPA',
                data: acseeResults.map(result => result.gpa),
                borderColor: '#00cec9',
                backgroundColor: 'rgba(0,206,201,0.15)',
                tension: 0.3,
                fill: true,
                pointBackgroundColor: '#00b894',
                pointBorderColor: '#fff',
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            plugins: {
                legend: { labels: { color: '#ccc' } }
            },
            scales: {
                y: { 
                    reverse: true, 
                    ticks: { color: '#ccc' },
                    title: {
                        display: true,
                        text: 'GPA',
                        color: '#ccc'
                    }
                },
                x: { 
                    ticks: { color: '#ccc' },
                    title: {
                        display: true,
                        text: 'Year',
                        color: '#ccc'
                    }
                }
            }
        }
    });

    // CSEE Division Chart
    const cseeDivisionCtx = document.getElementById('cseeDivisionChart').getContext('2d');
    let cseeDivisionChart = null;
    
    if (cseeResults.length > 0) {
        const latestCsee = cseeResults[cseeResults.length - 1];
        
        cseeDivisionChart = new Chart(cseeDivisionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Div I','Div II','Div III','Div IV','Div 0'],
                datasets: [{
                    data: [
                        latestCsee.division1 || 0,
                        latestCsee.division2 || 0,
                        latestCsee.division3 || 0,
                        latestCsee.division4 || 0,
                        latestCsee.division0 || 0
                    ],
                    backgroundColor: [
                        '#00b894','#0984e3','#fdcb6e','#e17055','#d63031'
                    ],
                    borderWidth: 1,
                    hoverOffset: 15
                }]
            },
            options: {
                plugins: {
                    title: { 
                        display: true, 
                        text: `CSEE Division Distribution (${latestCsee.year})`, 
                        color: '#74b9ff',
                        font: { size: 16 }
                    },
                    legend: { 
                        position: 'right', 
                        labels: { color: '#ccc', font: { size: 12 } } 
                    }
                }
            }
        });
    } else {
        cseeDivisionCtx.font = "16px Arial";
        cseeDivisionCtx.fillStyle = "#ccc";
        cseeDivisionCtx.textAlign = "center";
        cseeDivisionCtx.fillText("No CSEE data available", cseeDivisionCtx.canvas.width / 2, cseeDivisionCtx.canvas.height / 2);
    }

    // ACSEE Division Chart
    const acseeDivisionCtx = document.getElementById('acseeDivisionChart').getContext('2d');
    let acseeDivisionChart = null;
    
    if (acseeResults.length > 0) {
        const latestAcsee = acseeResults[acseeResults.length - 1];
        
        acseeDivisionChart = new Chart(acseeDivisionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Div I','Div II','Div III','Div IV','Div 0'],
                datasets: [{
                    data: [
                        latestAcsee.division1 || 0,
                        latestAcsee.division2 || 0,
                        latestAcsee.division3 || 0,
                        latestAcsee.division4 || 0,
                        latestAcsee.division0 || 0
                    ],
                    backgroundColor: [
                        '#00b894','#0984e3','#fdcb6e','#e17055','#d63031'
                    ],
                    borderWidth: 1,
                    hoverOffset: 15
                }]
            },
            options: {
                plugins: {
                    title: { 
                        display: true, 
                        text: `ACSEE Division Distribution (${latestAcsee.year})`, 
                        color: '#74b9ff',
                        font: { size: 16 }
                    },
                    legend: { 
                        position: 'right', 
                        labels: { color: '#ccc', font: { size: 12 } } 
                    }
                }
            }
        });
    } else {
        acseeDivisionCtx.font = "16px Arial";
        acseeDivisionCtx.fillStyle = "#ccc";
        acseeDivisionCtx.textAlign = "center";
        acseeDivisionCtx.fillText("No ACSEE data available", acseeDivisionCtx.canvas.width / 2, acseeDivisionCtx.canvas.height / 2);
    }

    // Performance Comparison Chart
    const performanceCtx = document.getElementById('performanceComparisonChart').getContext('2d');
    let performanceChart = null;
    
    // Find the latest year with both CSEE and ACSEE results
    let comparisonYear = null;
    const yearsWithBoth = [];
    
    for (let i = 0; i < cseeResults.length; i++) {
        const cseeYear = cseeResults[i].year;
        if (acseeResults.some(acsee => acsee.year === cseeYear)) {
            yearsWithBoth.push(cseeYear);
        }
    }
    
    if (yearsWithBoth.length > 0) {
        comparisonYear = Math.max(...yearsWithBoth);
        
        const cseeForYear = cseeResults.find(result => result.year == comparisonYear);
        const acseeForYear = acseeResults.find(result => result.year == comparisonYear);
        
        performanceChart = new Chart(performanceCtx, {
            type: 'bar',
            data: {
                labels: ['CSEE', 'ACSEE'],
                datasets: [{
                    label: `GPA Comparison (${comparisonYear})`,
                    data: [cseeForYear.gpa, acseeForYear.gpa],
                    backgroundColor: ['#74b9ff', '#00cec9'],
                    borderColor: ['#0984e3', '#00b894'],
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    legend: { 
                        labels: { color: '#ccc' } 
                    }
                },
                scales: {
                    y: { 
                        reverse: true,
                        ticks: { color: '#ccc' },
                        title: {
                            display: true,
                            text: 'GPA',
                            color: '#ccc'
                        }
                    },
                    x: { 
                        ticks: { color: '#ccc' },
                        title: {
                            display: true,
                            text: 'Exam Type',
                            color: '#ccc'
                        }
                    }
                }
            }
        });
    } else {
        performanceCtx.font = "16px Arial";
        performanceCtx.fillStyle = "#ccc";
        performanceCtx.textAlign = "center";
        performanceCtx.fillText("No comparison data available", performanceCtx.canvas.width / 2, performanceCtx.canvas.height / 2);
    }

    // Division Comparison Chart
    const divisionComparisonCtx = document.getElementById('divisionComparisonChart').getContext('2d');
    let divisionComparisonChart = null;
    
    if (yearsWithBoth.length > 0) {
        const cseeForYear = cseeResults.find(result => result.year == comparisonYear);
        const acseeForYear = acseeResults.find(result => result.year == comparisonYear);
        
        divisionComparisonChart = new Chart(divisionComparisonCtx, {
            type: 'bar',
            data: {
                labels: ['Div I', 'Div II', 'Div III', 'Div IV', 'Div 0'],
                datasets: [
                    {
                        label: `CSEE (${comparisonYear})`,
                        data: [
                            cseeForYear.division1 || 0,
                            cseeForYear.division2 || 0,
                            cseeForYear.division3 || 0,
                            cseeForYear.division4 || 0,
                            cseeForYear.division0 || 0
                        ],
                        backgroundColor: 'rgba(116,185,255,0.7)',
                        borderColor: '#0984e3',
                        borderWidth: 1
                    },
                    {
                        label: `ACSEE (${comparisonYear})`,
                        data: [
                            acseeForYear.division1 || 0,
                            acseeForYear.division2 || 0,
                            acseeForYear.division3 || 0,
                            acseeForYear.division4 || 0,
                            acseeForYear.division0 || 0
                        ],
                        backgroundColor: 'rgba(0,206,201,0.7)',
                        borderColor: '#00b894',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                plugins: {
                    legend: { 
                        labels: { color: '#ccc' } 
                    }
                },
                scales: {
                    y: { 
                        ticks: { color: '#ccc' },
                        title: {
                            display: true,
                            text: 'Number of Students',
                            color: '#ccc'
                        }
                    },
                    x: { 
                        ticks: { color: '#ccc' },
                        title: {
                            display: true,
                            text: 'Division',
                            color: '#ccc'
                        }
                    }
                }
            }
        });
    } else {
        divisionComparisonCtx.font = "16px Arial";
        divisionComparisonCtx.fillStyle = "#ccc";
        divisionComparisonCtx.textAlign = "center";
        divisionComparisonCtx.fillText("No comparison data available", divisionComparisonCtx.canvas.width / 2, divisionComparisonCtx.canvas.height / 2);
    }

    // Tab filtering functionality
    document.querySelectorAll('.exam-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // Update active tab
            document.querySelectorAll('.exam-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            const examType = this.getAttribute('data-exam');
            const rows = document.querySelectorAll('.result-row');
            
            rows.forEach(row => {
                if (examType === 'all' || row.getAttribute('data-exam') === examType) {
                    row.style.display = 'table-row';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });

    // Graph tab functionality
    document.querySelectorAll('.graph-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // Update active tab
            document.querySelectorAll('.graph-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            const graphType = this.getAttribute('data-graph');
            const sections = document.querySelectorAll('.graph-section');
            
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            document.getElementById(`${graphType}-section`).style.display = 'block';
        });
    });
</script>
{% endblock %}