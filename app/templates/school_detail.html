{% extends "base.html" %}
{% load humanize %}
{% load custom_filters %}
{% block title %}{{ school.name }} - Details - NECTA Results{% endblock %}

{% block extra_css %}
<style>
    
    /* School Header */
    .school-header {
        background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        color: #f5f6fa;
        padding: 2rem;
        border-radius: 14px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }
    .school-header h1 {
        color: #dfe6e9;
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.2rem;
        margin: 1.5rem 0;
    }
    .stat-card {
        background: var(--card-bg);
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 2px 12px rgba(0,0,0,0.5);
        transition: transform 0.2s ease-in-out, box-shadow 0.2s;
        border: 1px solid var(--border-color);
    }
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.7);
    }
    .stat-number {
        font-size: 1.9rem;
        font-weight: 800;
        color: var(--accent);
        margin-bottom: 0.5rem;
    }
    .stat-label {
        font-size: 0.85rem;
        color: var(--muted-text);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Table */
    .results-table {
        font-size: 0.9rem;
        background: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }
    .results-table th {
        background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        color: #fff;
    }
    .results-table tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }

    /* Charts */
    .chart-container {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 18px rgba(0,0,0,0.5);
        border: 1px solid var(--border-color);
        position: relative;
    }
    .chart-title {
        color: var(--accent);
        font-size: 1.1rem;
        margin-bottom: 1rem;
        text-align: center;
        font-weight: 600;
    }

    /* Chart controls */
    .chart-controls {
        position: absolute;
        top: 10px;
        right: 15px;
        display: flex;
        gap: 5px;
        z-index: 10;
    }
    .chart-btn {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        width: 30px;
        height: 30px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    .chart-btn:hover {
        background: var(--accent);
        color: white;
    }

    /* Full screen modal */
    .fullscreen-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    
    .fullscreen-modal.active {
        display: flex;
    }
    
    .fullscreen-chart-container {
        width: 90%;
        height: 80%;
        background: var(--card-bg);
        border-radius: 12px;
        padding: 2rem;
        position: relative;
    }
    
    .fullscreen-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .fullscreen-title {
        color: var(--accent);
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
    }
    
    .close-fullscreen {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .close-fullscreen:hover {
        background: var(--accent);
        color: white;
    }
    
    .fullscreen-chart {
        width: 100%;
        height: calc(100% - 60px);
    }

    /* Breadcrumb */
    .breadcrumb {
        background: none;
        padding: 0;
        margin-bottom: 1.5rem;
    }
    .breadcrumb a {
        color: var(--accent);
        text-decoration: none;
    }
    .breadcrumb a:hover {
        text-decoration: underline;
    }

    /* Button */
    .btn-primary {
        background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        border: none;
        padding: 0.7rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        box-shadow: 0 3px 10px rgba(0,0,0,0.4);
    }
    .btn-primary:hover {
        opacity: 0.9;
    }

    /* Tabs for exam type filtering */
    .exam-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 1rem;
    }
    .exam-tab {
        padding: 0.5rem 1.5rem;
        margin: 0 0.5rem;
        border-radius: 20px;
        background: var(--secondary-bg);
        color: var(--muted-text);
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .exam-tab.active {
        background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        color: white;
    }
    .exam-tab:hover:not(.active) {
        background: var(--primary-bg);
    }

    /* Graph tabs */
    .graph-tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }
    .graph-tab {
        padding: 0.5rem 1rem;
        margin: 0 0.3rem 0.5rem;
        border-radius: 8px;
        background: var(--secondary-bg);
        color: var(--muted-text);
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }
    .graph-tab.active {
        background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        color: white;
    }
    .graph-tab:hover:not(.active) {
        background: var(--primary-bg);
    }

    @media (max-width: 768px) {
        .stat-number { font-size: 1.5rem; }
        .exam-tabs { flex-wrap: wrap; }
        .exam-tab { margin-bottom: 0.5rem; }
        .graph-tabs { flex-wrap: wrap; }
        .graph-tab { margin-bottom: 0.5rem; }
        
        .fullscreen-chart-container {
            width: 95%;
            height: 85%;
            padding: 1rem;
        }
        
        .fullscreen-title {
            font-size: 1.2rem;
        }
    }
    /* Subject grades styling */
.subject-grades {
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
}

.subject-grades .badge {
    font-size: 0.75rem;
    padding: 0.35rem 0.6rem;
}

/* Pink color for female badge */
.bg-pink {
    background-color: #e84393 !important;
}

/* Chart responsiveness */
@media (max-width: 768px) {
    .subject-grades .badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.4rem;
    }
}
/* Mobile-friendly student results */
@media (max-width: 768px) {
    .student-results-card .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .student-results-card table {
        min-width: 600px; /* Ensure table doesn't get too narrow */
    }
    
    .subject-grades {
        max-width: 300px;
    }
    
    .subject-grades .badge {
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
        margin-bottom: 0.2rem;
    }
}

/* Mobile-specific styles for very small screens */
@media (max-width: 480px) {
    .student-results-card {
        margin-left: -15px;
        margin-right: -15px;
        border-radius: 0;
    }
    
    .subject-grades {
        max-width: 250px;
    }
    
    .subject-grades .badge {
        font-size: 0.6rem;
        padding: 0.15rem 0.3rem;
    }
}

/* Full screen modal improvements */
.fullscreen-modal .fullscreen-chart-container {
    width: 95%;
    height: 85%;
    padding: 1rem;
}

.fullscreen-modal .fullscreen-title {
    font-size: 1.2rem;
}

/* Ensure charts are visible in full screen */
.fullscreen-chart {
    width: 100% !important;
    height: 100% !important;
}


/* Student details modal styling */
.subject-grades-detailed {
    max-height: 300px;
    overflow-y: auto;
}

.subject-grades-detailed .subject-name {
    font-weight: 500;
}

.grade-badge {
    font-size: 1.1rem;
    min-width: 30px;
    text-align: center;
}

/* Full screen modal improvements */
.fullscreen-modal {
    z-index: 99999; /* Ensure it's above everything */
}

.fullscreen-modal .fullscreen-chart-container {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
}

/* Mobile modal improvements */
@media (max-width: 768px) {
    .subject-grades-detailed {
        max-height: 200px;
    }
    
    .modal-dialog {
        margin: 0.5rem;
    }
    
    .modal-content {
        border-radius: 12px;
    }
}

.subject-performance-table th {
    vertical-align: middle;
    text-align: center;
    font-size: 0.9rem;
}

.subject-performance-table td {
    vertical-align: middle;
    font-size: 0.9rem;
}

.rank-1 { 
    color: #fdcb6e; 
    font-weight: bold;
    font-size: 1.2em;
}
.rank-2 { 
    color: #74b9ff; 
    font-weight: bold;
    font-size: 1.1em;
}
.rank-3 { 
    color: #00cec9; 
    font-weight: bold;
    font-size: 1.1em;
}

.subject-rank {
    font-weight: bold;
    text-align: center;
}

/* Medal colors for top 3 */
.rank-1::before { content: "ðŸ¥‡ "; }
.rank-2::before { content: "ðŸ¥ˆ "; }
.rank-3::before { content: "ðŸ¥‰ "; }
</style>
{% endblock %}

{% block content %}
<!-- Breadcrumb -->
{% comment %} <nav aria-label="breadcrumb" class="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'school_rankings' 'ACSEE' 2023 %}">ACSEE 2023 Rankings</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ school.name }}</li>
    </ol>
</nav> {% endcomment %}

<!-- School Header -->
<div class="school-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="display-6 fw-bold mb-2">{{ school.name }}</h1>
            <p class="mb-1"><strong>Code:</strong> {{ school.code }}</p>
            <p class="mb-0"><strong>Region:</strong> {{ school.region }}</p>
        </div>
        <div class="col-md-4 text-md-end">
            <span class="badge bg-dark text-light fs-6 shadow-sm">
                {% comment %} <i class="fas fa-clipboard-list me-1"></i> {% endcomment %}
                {{ results|length }} Records
            </span>
        </div>
    </div>
</div>

<!-- Exam Type Tabs -->
<div class="exam-tabs">
    <div class="exam-tab {% if latest_exam == 'all' %}active{% endif %}" data-exam="all" data-year="{{ latest_year }}">All Results</div>
    <div class="exam-tab {% if latest_exam == 'CSEE' %}active{% endif %}" data-exam="CSEE" data-year="{{ latest_year }}">CSEE Results</div>
    <div class="exam-tab {% if latest_exam == 'ACSEE' %}active{% endif %}" data-exam="ACSEE" data-year="{{ latest_year }}">ACSEE Results</div>
</div>
<!-- Graph Type Tabs -->
<div class="graph-tabs">
    <div class="graph-tab active" data-graph="gpa">GPA Trends</div>
    <div class="graph-tab" data-graph="division">Division Distribution</div>
    <div class="graph-tab" data-graph="comparison">Performance Comparison</div>
</div>

<!-- GPA Charts -->
<div class="graph-section" id="gpa-section">
    <div class="row">
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">CSEE GPA Trend</div>
                <div class="chart-controls">
                    <button class="chart-btn fullscreen-btn" data-chart="cseeGpaChart" data-title="CSEE GPA Trend">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                <canvas id="cseeGpaChart" height="250"></canvas>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">ACSEE GPA Trend</div>
                <div class="chart-controls">
                    <button class="chart-btn fullscreen-btn" data-chart="acseeGpaChart" data-title="ACSEE GPA Trend">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                <canvas id="acseeGpaChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Division Charts -->
<div class="graph-section" id="division-section" style="display: none;">
    <div class="row">
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">CSEE Division Distribution</div>
                <div class="chart-controls">
                    <button class="chart-btn fullscreen-btn" data-chart="cseeDivisionChart" data-title="CSEE Division Distribution">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                <canvas id="cseeDivisionChart" height="250"></canvas>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">ACSEE Division Distribution</div>
                <div class="chart-controls">
                    <button class="chart-btn fullscreen-btn" data-chart="acseeDivisionChart" data-title="ACSEE Division Distribution">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                <canvas id="acseeDivisionChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Comparison Charts -->
<div class="graph-section" id="comparison-section" style="display: none;">
    <div class="row">
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">CSEE vs ACSEE GPA Comparison</div>
                <div class="chart-controls">
                    <button class="chart-btn fullscreen-btn" data-chart="performanceComparisonChart" data-title="CSEE vs ACSEE GPA Comparison">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                <canvas id="performanceComparisonChart" height="250"></canvas>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">Division I Comparison</div>
                <div class="chart-controls">
                    <button class="chart-btn fullscreen-btn" data-chart="divisionComparisonChart" data-title="Division I Comparison">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
                <canvas id="divisionComparisonChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Full Screen Modal -->
<div class="fullscreen-modal" id="fullscreenModal">
    <div class="fullscreen-chart-container">
        <div class="fullscreen-header">
            <h3 class="fullscreen-title" id="fullscreenTitle"></h3>
            <button class="close-fullscreen" id="closeFullscreen">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="fullscreen-chart">
            <canvas id="fullscreenChart"></canvas>
        </div>
    </div>
</div>

<!-- Student Results Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm student-results-card">
            <div class="card-header bg-gradient text-white fw-bold d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-user-graduate me-2"></i> Student Results 
                    {% if latest_year and latest_exam %}
                    ({{ latest_year }} {{ latest_exam }})
                    {% endif %}
                </span>
                <span class="badge bg-light text-dark">
                    {{ student_results|length }} students
                </span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover results-table mb-0">
                        <thead>
                            <tr>
                                <th>Candidate #</th>
                                <th>Sex</th>
                                <th>Aggregate</th>
                                <th>Division</th>
                                <th>Subjects & Grades</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in student_results %}
                            <tr>
                                <td><strong>{{ student.candidate_number }}</strong></td>
                                <td>
                                    <span class="badge {% if student.sex == 'M' %}bg-primary{% else %}bg-pink{% endif %}">
                                        {{ student.sex }}
                                    </span>
                                </td>
                                <td class="fw-bold text-info">{{ student.aggregate_score }}</td>
                                <td>
                                    <span class="badge 
                                        {% if student.division == 'I' %}bg-success
                                        {% elif student.division == 'II' %}bg-primary
                                        {% elif student.division == 'III' %}bg-warning
                                        {% elif student.division == 'IV' %}bg-secondary
                                        {% else %}bg-danger{% endif %}">
                                        {{ student.division }}
                                    </span>
                                </td>
                                <td>
                                    <div class="subject-grades">
                                        {% for subject, grade in student.subjects_list %}
                                            <span class="badge bg-dark text-light me-1 mb-1" 
                                                  data-bs-toggle="tooltip" title="{{ subject }}: {{ grade }}">
                                                {{ subject|slice:":8" }}{% if subject|length > 8 %}...{% endif %}:
                                                <span class="fw-bold 
                                                    {% if grade == 'A' %}text-success
                                                    {% elif grade == 'B' %}text-primary
                                                    {% elif grade == 'C' %}text-info
                                                    {% elif grade == 'D' %}text-warning
                                                    {% elif grade == 'E' or grade == 'S' %}text-secondary
                                                    {% else %}text-danger{% endif %}">
                                                    {{ grade }}
                                                </span>
                                            </span>
                                        {% empty %}
                                            <span class="text-muted small">No data</span>
                                        {% endfor %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-3">
                                    No student results available for {{ latest_exam }} {{ latest_year }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Subject Performance Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-gradient text-white fw-bold">
                <i class="fas fa-trophy me-2"></i> Subject Performance Ranking vs All Schools
                {% if latest_year and latest_exam %}
                ({{ latest_year }} {{ latest_exam }})
                {% endif %}
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover subject-performance-table mb-0">
                        <thead>
                            <tr>
                                <th>Subject Rank</th>
                                <th>Subject</th>
                                <th class="text-center">School GPA</th>
                                <th class="text-center">National Avg GPA</th>
                                <th class="text-center">Top School GPA</th>
                                <th class="text-center">Performance</th>
                                <th class="text-center">Schools Offering</th>
                                <th class="text-center">Percentile</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for subject_data in subject_performances %}
                            {% with subject=subject_data.subject %}
                                {# Skip subjects where this school is the only one offering it OR subject name is a number #}
                                {% if subject_data.total_schools_offering > 1 and not subject.subject_name|is_numeric %}
                                <tr>
                                    <td class="subject-rank {% if subject_data.subject_rank <= 3 %}rank-{{ subject_data.subject_rank}}{% endif %}">
                                        {{ subject_data.subject_rank }}
                                    </td>
                                    <td>
                                        <strong>{{ subject.subject_code }}</strong><br>
                                        <small>{{ subject.subject_name }}</small>
                                    </td>
                                    <td class="text-center fw-bold {% if subject_data.subject_rank <= 10 %}text-success{% elif subject_data.subject_rank <= 50 %}text-primary{% else %}text-warning{% endif %}">
                                        {{ subject.gpa|floatformat:2 }}
                                    </td>
                                    <td class="text-center">
                                        {{ subject_data.national_avg_gpa|floatformat:2 }}
                                    </td>
                                    <td class="text-center">
                                        {{ subject_data.top_performer_gpa|floatformat:2 }}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge 
                                            {% if subject_data.subject_rank <= 10 %}bg-success
                                            {% elif subject_data.subject_rank <= 50 %}bg-primary
                                            {% elif subject_data.subject_rank <= 100 %}bg-warning
                                            {% else %}bg-secondary{% endif %}">
                                            {{ subject_data.performance_label }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        {{ subject_data.total_schools_offering }}
                                    </td>
                                    <td class="text-center fw-bold {% if subject_data.percentile >= 90 %}text-success{% elif subject_data.percentile >= 75 %}text-primary{% else %}text-info{% endif %}">
                                        {{ subject_data.percentile|floatformat:1 }}%
                                    </td>
                                </tr>
                                {% endif %}
                            {% endwith %}
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center text-muted py-3">
                                    No subject performance data available for {{ latest_exam }} {{ latest_year }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Performance Legend -->
                <div class="card-footer bg-light">
                    <small class="text-muted">
                        <strong>Performance Legend:</strong>
                        <span class="badge bg-success me-2">Top 10</span>
                        <span class="badge bg-primary me-2">Top 50</span>
                        <span class="badge bg-warning me-2">Top 100</span>
                        <span class="badge bg-secondary me-2">Other</span>
                        | Lower GPA = Better Performance
                        <span class="float-end">
                            <i class="fas fa-info-circle text-primary"></i> 
                            Subjects offered by only one school or with invalid names are not displayed
                        </span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Subject Analysis Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-gradient text-white fw-bold">
                <i class="fas fa-chart-bar me-2"></i> Subject Performance Analysis
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">Subject Grade Distribution</div>
                            <div class="chart-controls">
                                <button class="chart-btn fullscreen-btn" data-chart="subjectGradeChart" data-title="Subject Grade Distribution">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                            <canvas id="subjectGradeChart" height="300"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">Top Performing Subjects</div>
                            <div class="chart-controls">
                                <button class="chart-btn fullscreen-btn" data-chart="subjectPerformanceChart" data-title="Top Performing Subjects">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                            <canvas id="subjectPerformanceChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Student Details Modal -->
<div class="modal fade" id="studentDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient text-white">
                <h5 class="modal-title">Student Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Candidate Number:</strong> <span id="modal-candidate-number"></span></p>
                        <p><strong>Sex:</strong> <span id="modal-sex" class="badge bg-primary"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Aggregate Score:</strong> <span id="modal-aggregate" class="fw-bold text-info"></span></p>
                        <p><strong>Division:</strong> <span id="modal-division" class="badge bg-success"></span></p>
                    </div>
                </div>
                <hr>
                <h6 class="mb-3">Subjects & Grades:</h6>
                <div class="subject-grades-detailed" id="modal-subjects"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Full Screen Modals for Subject Charts -->
<div class="fullscreen-modal" id="fullscreenSubjectGradeModal">
    <div class="fullscreen-chart-container">
        <div class="fullscreen-header">
            <h3 class="fullscreen-title">Subject Grade Distribution</h3>
            <button class="close-fullscreen" data-modal="fullscreenSubjectGradeModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="fullscreen-chart">
            <canvas id="fullscreenSubjectGradeChart"></canvas>
        </div>
    </div>
</div>

<div class="fullscreen-modal" id="fullscreenSubjectPerformanceModal">
    <div class="fullscreen-chart-container">
        <div class="fullscreen-header">
            <h3 class="fullscreen-title">Top Performing Subjects</h3>
            <button class="close-fullscreen" data-modal="fullscreenSubjectPerformanceModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="fullscreen-chart">
            <canvas id="fullscreenSubjectPerformanceChart"></canvas>
        </div>
    </div>
</div>

<!-- Exam Results -->
<div class="card border-0 shadow-sm mt-3">
    <div class="card-header bg-gradient text-white fw-bold">
        <i class="fas fa-history me-2"></i> Exam Results History
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover results-table mb-0">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Exam Type</th>
                        <th>GPA</th>
                        <th class="text-center">Div I</th>
                        <th class="text-center">Div II</th>
                        <th class="text-center">Div III</th>
                        <th class="text-center">Div IV</th>
                        <th class="text-center">Div 0</th>
                        <th class="text-center">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in results %}
                    <tr class="result-row" data-exam="{{ result.exam }}">
                        <td><strong>{{ result.year }}</strong></td>
                        <td>{{ result.exam }}</td>
                        <td class="fw-bold text-info">{{ result.gpa|floatformat:4 }}</td>
                        <td class="text-center text-success">{{ result.division1 }}</td>
                        <td class="text-center text-primary">{{ result.division2 }}</td>
                        <td class="text-center text-warning">{{ result.division3 }}</td>
                        <td class="text-center text-muted">{{ result.division4 }}</td>
                        <td class="text-center text-danger">{{ result.division0 }}</td>
                        <td class="text-center fw-bold">{{ result.total }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Back Button -->
<div class="text-center mt-4">
    <a href="{% url 'school_rankings' 'ACSEE' 2023 %}" class="btn btn-primary">
        <i class="fas fa-arrow-left me-1"></i> Back to Rankings
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Prepare data for charts
const cseeResults = [];
const acseeResults = [];

{% for result in results %}
    {% if result.exam == "CSEE" %}
        cseeResults.push({
            year: '{{ result.year }}',
            gpa: {{ result.gpa }},
            division1: {{ result.division1 }},
            division2: {{ result.division2 }},
            division3: {{ result.division3 }},
            division4: {{ result.division4 }},
            division0: {{ result.division0 }},
            total: {{ result.total }}
        });
    {% elif result.exam == "ACSEE" %}
        acseeResults.push({
            year: '{{ result.year }}',
            gpa: {{ result.gpa }},
            division1: {{ result.division1 }},
            division2: {{ result.division2 }},
            division3: {{ result.division3 }},
            division4: {{ result.division4 }},
            division0: {{ result.division0 }},
            total: {{ result.total }}
        });
    {% endif %}
{% endfor %}

// Sort results by year
cseeResults.sort((a, b) => a.year - b.year);
acseeResults.sort((a, b) => a.year - b.year);

// Chart instances
let cseeGpaChart, acseeGpaChart, cseeDivisionChart, acseeDivisionChart, 
    performanceChart, divisionComparisonChart, fullscreenChart;

// Initialize all charts
function initCharts() {
    // CSEE GPA Chart
    const cseeGpaCtx = document.getElementById('cseeGpaChart').getContext('2d');
    cseeGpaChart = new Chart(cseeGpaCtx, {
        type: 'line',
        data: {
            labels: cseeResults.map(result => result.year),
            datasets: [{
                label: 'CSEE GPA',
                data: cseeResults.map(result => result.gpa),
                borderColor: '#74b9ff',
                backgroundColor: 'rgba(116,185,255,0.15)',
                tension: 0.3,
                fill: true,
                pointBackgroundColor: '#0984e3',
                pointBorderColor: '#fff',
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            plugins: {
                legend: { labels: { color: 'var(--muted-text)' } }
            },
            scales: {
                y: { 
                    reverse: true, 
                    ticks: { color: 'var(--muted-text)' },
                    title: {
                        display: true,
                        text: 'GPA',
                        color: 'var(--muted-text)'
                    }
                },
                x: { 
                    ticks: { color: 'var(--muted-text)' },
                    title: {
                        display: true,
                        text: 'Year',
                        color: 'var(--muted-text)'
                    }
                }
            }
        }
    });

    // ACSEE GPA Chart
    const acseeGpaCtx = document.getElementById('acseeGpaChart').getContext('2d');
    acseeGpaChart = new Chart(acseeGpaCtx, {
        type: 'line',
        data: {
            labels: acseeResults.map(result => result.year),
            datasets: [{
                label: 'ACSEE GPA',
                data: acseeResults.map(result => result.gpa),
                borderColor: '#00cec9',
                backgroundColor: 'rgba(0,206,201,0.15)',
                tension: 0.3,
                fill: true,
                pointBackgroundColor: '#00b894',
                pointBorderColor: '#fff',
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            plugins: {
                legend: { labels: { color: 'var(--muted-text)' } }
            },
            scales: {
                y: { 
                    reverse: true, 
                    ticks: { color: 'var(--muted-text)' },
                    title: {
                        display: true,
                        text: 'GPA',
                        color: 'var(--muted-text)'
                    }
                },
                x: { 
                    ticks: { color: 'var(--muted-text)' },
                    title: {
                        display: true,
                        text: 'Year',
                        color: 'var(--muted-text)'
                    }
                }
            }
        }
    });

    // CSEE Division Chart
    const cseeDivisionCtx = document.getElementById('cseeDivisionChart').getContext('2d');
    
    if (cseeResults.length > 0) {
        const latestCsee = cseeResults.find(result => result.year == '{{ latest_year }}') || cseeResults[cseeResults.length - 1];
        
        cseeDivisionChart = new Chart(cseeDivisionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Div I','Div II','Div III','Div IV','Div 0'],
                datasets: [{
                    data: [
                        latestCsee.division1 || 0,
                        latestCsee.division2 || 0,
                        latestCsee.division3 || 0,
                        latestCsee.division4 || 0,
                        latestCsee.division0 || 0
                    ],
                    backgroundColor: [
                        '#00b894','#0984e3','#fdcb6e','#e17055','#d63031'
                    ],
                    borderWidth: 1,
                    hoverOffset: 15
                }]
            },
            options: {
                plugins: {
                    title: { 
                        display: true, 
                        text: `CSEE Division Distribution (${latestCsee.year})`, 
                        color: 'var(--accent)',
                        font: { size: 16 }
                    },
                    legend: { 
                        position: 'right', 
                        labels: { color: 'var(--muted-text)', font: { size: 12 } } 
                    }
                }
            }
        });
    } else {
        cseeDivisionCtx.font = "16px Arial";
        cseeDivisionCtx.fillStyle = "var(--muted-text)";
        cseeDivisionCtx.textAlign = "center";
        cseeDivisionCtx.fillText("No CSEE data available", cseeDivisionCtx.canvas.width / 2, cseeDivisionCtx.canvas.height / 2);
    }

    // ACSEE Division Chart
    const acseeDivisionCtx = document.getElementById('acseeDivisionChart').getContext('2d');
    
    if (acseeResults.length > 0) {
        const latestAcsee = acseeResults.find(result => result.year == '{{ latest_year }}') || acseeResults[acseeResults.length - 1];
        
        acseeDivisionChart = new Chart(acseeDivisionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Div I','Div II','Div III','Div IV','Div 0'],
                datasets: [{
                    data: [
                        latestAcsee.division1 || 0,
                        latestAcsee.division2 || 0,
                        latestAcsee.division3 || 0,
                        latestAcsee.division4 || 0,
                        latestAcsee.division0 || 0
                    ],
                    backgroundColor: [
                        '#00b894','#0984e3','#fdcb6e','#e17055','#d63031'
                    ],
                    borderWidth: 1,
                    hoverOffset: 15
                }]
            },
            options: {
                plugins: {
                    title: { 
                        display: true, 
                        text: `ACSEE Division Distribution (${latestAcsee.year})`, 
                        color: 'var(--accent)',
                        font: { size: 16 }
                    },
                    legend: { 
                        position: 'right', 
                        labels: { color: 'var(--muted-text)', font: { size: 12 } } 
                    }
                }
            }
        });
    } else {
        acseeDivisionCtx.font = "16px Arial";
        acseeDivisionCtx.fillStyle = "var(--muted-text)";
        acseeDivisionCtx.textAlign = "center";
        acseeDivisionCtx.fillText("No ACSEE data available", acseeDivisionCtx.canvas.width / 2, acseeDivisionCtx.canvas.height / 2);
    }

    // Performance Comparison Chart
    const performanceCtx = document.getElementById('performanceComparisonChart').getContext('2d');
    
    // Find the selected year or the latest year with both CSEE and ACSEE results
    const selectedYear = '{{ latest_year }}';
    const cseeForYear = cseeResults.find(result => result.year == selectedYear);
    const acseeForYear = acseeResults.find(result => result.year == selectedYear);
    
    if (cseeForYear && acseeForYear) {
        performanceChart = new Chart(performanceCtx, {
            type: 'bar',
            data: {
                labels: ['CSEE', 'ACSEE'],
                datasets: [{
                    label: `GPA Comparison (${selectedYear})`,
                    data: [cseeForYear.gpa, acseeForYear.gpa],
                    backgroundColor: ['#74b9ff', '#00cec9'],
                    borderColor: ['#0984e3', '#00b894'],
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    legend: { 
                        labels: { color: 'var(--muted-text)' } 
                    }
                },
                scales: {
                    y: { 
                        reverse: true,
                        ticks: { color: 'var(--muted-text)' },
                        title: {
                            display: true,
                            text: 'GPA',
                            color: 'var(--muted-text)'
                        }
                    },
                    x: { 
                        ticks: { color: 'var(--muted-text)' },
                        title: {
                            display: true,
                            text: 'Exam Type',
                            color: 'var(--muted-text)'
                        }
                    }
                }
            }
        });
    } else {
        performanceCtx.font = "16px Arial";
        performanceCtx.fillStyle = "var(--muted-text)";
        performanceCtx.textAlign = "center";
        performanceCtx.fillText("No comparison data available", performanceCtx.canvas.width / 2, performanceCtx.canvas.height / 2);
    }

    // Division Comparison Chart
    const divisionComparisonCtx = document.getElementById('divisionComparisonChart').getContext('2d');
    
    if (cseeForYear && acseeForYear) {
        divisionComparisonChart = new Chart(divisionComparisonCtx, {
            type: 'bar',
            data: {
                labels: ['Div I', 'Div II', 'Div III', 'Div IV', 'Div 0'],
                datasets: [
                    {
                        label: `CSEE (${selectedYear})`,
                        data: [
                            cseeForYear.division1 || 0,
                            cseeForYear.division2 || 0,
                            cseeForYear.division3 || 0,
                            cseeForYear.division4 || 0,
                            cseeForYear.division0 || 0
                        ],
                        backgroundColor: 'rgba(116,185,255,0.7)',
                        borderColor: '#0984e3',
                        borderWidth: 1
                    },
                    {
                        label: `ACSEE (${selectedYear})`,
                        data: [
                            acseeForYear.division1 || 0,
                            acseeForYear.division2 || 0,
                            acseeForYear.division3 || 0,
                            acseeForYear.division4 || 0,
                            acseeForYear.division0 || 0
                        ],
                        backgroundColor: 'rgba(0,206,201,0.7)',
                        borderColor: '#00b894',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                plugins: {
                    legend: { 
                        labels: { color: 'var(--muted-text)' } 
                    }
                },
                scales: {
                    y: { 
                        ticks: { color: 'var(--muted-text)' },
                        title: {
                            display: true,
                            text: 'Number of Students',
                            color: 'var(--muted-text)'
                        }
                    },
                    x: { 
                        ticks: { color: 'var(--muted-text)' },
                        title: {
                            display: true,
                            text: 'Division',
                            color: 'var(--muted-text)'
                        }
                    }
                }
            }
        });
    } else {
        divisionComparisonCtx.font = "16px Arial";
        divisionComparisonCtx.fillStyle = "var(--muted-text)";
        divisionComparisonCtx.textAlign = "center";
        divisionComparisonCtx.fillText("No comparison data available", divisionComparisonCtx.canvas.width / 2, divisionComparisonCtx.canvas.height / 2);
    }
}

// Initialize charts on page load
initCharts();

// Full screen functionality
const fullscreenModal = document.getElementById('fullscreenModal');
const fullscreenTitle = document.getElementById('fullscreenTitle');
const fullscreenCanvas = document.getElementById('fullscreenChart');
const closeFullscreenBtn = document.getElementById('closeFullscreen');

// Open chart in full screen
document.querySelectorAll('.fullscreen-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const chartId = this.getAttribute('data-chart');
        const title = this.getAttribute('data-title');
        
        fullscreenTitle.textContent = title;
        
        let chart;
        switch(chartId) {
            case 'cseeGpaChart': chart = cseeGpaChart; break;
            case 'acseeGpaChart': chart = acseeGpaChart; break;
            case 'cseeDivisionChart': chart = cseeDivisionChart; break;
            case 'acseeDivisionChart': chart = acseeDivisionChart; break;
            case 'performanceComparisonChart': chart = performanceChart; break;
            case 'divisionComparisonChart': chart = divisionComparisonChart; break;
        }
        
        if (chart) {
            fullscreenModal.classList.add('active');
            
            if (fullscreenChart) {
                fullscreenChart.destroy();
            }
            
            const ctx = fullscreenCanvas.getContext('2d');
            fullscreenChart = new Chart(ctx, {
                type: chart.config.type,
                data: JSON.parse(JSON.stringify(chart.config.data)),
                options: JSON.parse(JSON.stringify(chart.config.options))
            });
            
            fullscreenChart.options.maintainAspectRatio = false;
            fullscreenChart.options.plugins.title = {
                display: true,
                text: title,
                font: { size: 18 },
                color: 'var(--accent)'
            };
            fullscreenChart.update();
        }
    });
});

// Close full screen
closeFullscreenBtn.addEventListener('click', function() {
    fullscreenModal.classList.remove('active');
    if (fullscreenChart) {
        fullscreenChart.destroy();
        fullscreenChart = null;
    }
});

// Close modal when clicking outside
fullscreenModal.addEventListener('click', function(e) {
    if (e.target === fullscreenModal) {
        fullscreenModal.classList.remove('active');
        if (fullscreenChart) {
            fullscreenChart.destroy();
            fullscreenChart = null;
        }
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && fullscreenModal.classList.contains('active')) {
        fullscreenModal.classList.remove('active');
        if (fullscreenChart) {
            fullscreenChart.destroy();
            fullscreenChart = null;
        }
    }
});

// Tab filtering functionality
document.querySelectorAll('.exam-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.exam-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        const examType = this.getAttribute('data-exam');
        const year = this.getAttribute('data-year');
        const rows = document.querySelectorAll('.result-row');
        
        rows.forEach(row => {
            const rowExam = row.getAttribute('data-exam');
            const rowYear = row.getAttribute('data-year');
            if (examType === 'all' || (rowExam === examType && rowYear === year)) {
                row.style.display = 'table-row';
            } else {
                row.style.display = 'none';
            }
        });
    });
});

// Graph tab functionality
document.querySelectorAll('.graph-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.graph-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        const graphType = this.getAttribute('data-graph');
        const sections = document.querySelectorAll('.graph-section');
        
        sections.forEach(section => {
            section.style.display = 'none';
        });
        
        document.getElementById(`${graphType}-section`).style.display = 'block';
    });
});

// Use pre-processed subject data from Django
const subjectData = {{ subject_data_json|safe }};

// Calculate average grade for each subject
function calculateSubjectAverages(subjectData) {
    const averages = {};
    
    for (const [subject, grades] of Object.entries(subjectData)) {
        let totalScore = 0;
        let totalStudents = 0;
        
        const gradeValues = {
            'A': 1, 'B': 2, 'C': 3, 'D': 4, 'E': 5, 'S': 6, 'F': 7
        };
        
        for (const [grade, count] of Object.entries(grades)) {
            if (grade !== 'total' && gradeValues[grade]) {
                totalScore += gradeValues[grade] * count;
                totalStudents += count;
            }
        }
        
        averages[subject] = totalStudents > 0 ? (totalScore / totalStudents) : 0;
    }
    
    return averages;
}

// Initialize subject analysis charts
function initSubjectCharts() {
    const subjectAverages = calculateSubjectAverages(subjectData);
    
    const subjects = Object.keys(subjectData);
    
    const subjectGradeCtx = document.getElementById('subjectGradeChart').getContext('2d');
    const subjectGradeChart = new Chart(subjectGradeCtx, {
        type: 'bar',
        data: {
            labels: subjects.map(sub => sub.length > 15 ? sub.substring(0, 15) + '...' : sub),
            datasets: [
                {
                    label: 'A',
                    data: subjects.map(subject => subjectData[subject].A || 0),
                    backgroundColor: '#00b894',
                    stack: 'Stack 0'
                },
                {
                    label: 'B',
                    data: subjects.map(subject => subjectData[subject].B || 0),
                    backgroundColor: '#0984e3',
                    stack: 'Stack 0'
                },
                {
                    label: 'C',
                    data: subjects.map(subject => subjectData[subject].C || 0),
                    backgroundColor: '#fdcb6e',
                    stack: 'Stack 0'
                },
                {
                    label: 'D',
                    data: subjects.map(subject => subjectData[subject].D || 0),
                    backgroundColor: '#e17055',
                    stack: 'Stack 0'
                },
                {
                    label: 'E/S',
                    data: subjects.map(subject => (subjectData[subject].E || 0) + (subjectData[subject].S || 0)),
                    backgroundColor: '#6c5ce7',
                    stack: 'Stack 0'
                },
                {
                    label: 'F',
                    data: subjects.map(subject => subjectData[subject].F || 0),
                    backgroundColor: '#d63031',
                    stack: 'Stack 0'
                }
            ]
        },
        options: {
            plugins: {
                legend: { 
                    labels: { color: 'var(--muted-text)' },
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Grade Distribution by Subject ({{ latest_year }} {{ latest_exam }})',
                    color: 'var(--accent)'
                }
            },
            scales: {
                x: {
                    stacked: true,
                    ticks: { color: 'var(--muted-text)' }
                },
                y: {
                    stacked: true,
                    ticks: { color: 'var(--muted-text)' },
                    title: {
                        display: true,
                        text: 'Number of Students',
                        color: 'var(--muted-text)'
                    }
                }
            }
        }
    });
    
    const sortedSubjects = Object.entries(subjectAverages)
        .sort(([,a], [,b]) => a - b)
        .slice(0, 10);
    
    const subjectPerformanceCtx = document.getElementById('subjectPerformanceChart').getContext('2d');
    const subjectPerformanceChart = new Chart(subjectPerformanceCtx, {
        type: 'bar',
        data: {
            labels: sortedSubjects.map(([subject]) => 
                subject.length > 20 ? subject.substring(0, 20) + '...' : subject),
            datasets: [{
                label: 'Average Grade Score (Lower is Better)',
                data: sortedSubjects.map(([,avg]) => avg),
                backgroundColor: sortedSubjects.map(([,avg]) => {
                    if (avg <= 2.0) return '#00b894';
                    if (avg <= 3.0) return '#74b9ff';
                    if (avg <= 4.0) return '#fdcb6e';
                    if (avg <= 5.0) return '#e17055';
                    return '#d63031';
                }),
                borderColor: 'rgba(0,0,0,0.1)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y',
            plugins: {
                legend: { 
                    labels: { color: 'var(--muted-text)' },
                    display: false
                },
                title: {
                    display: true,
                    text: 'Subject Performance ({{ latest_year }} {{ latest_exam }})',
                    color: 'var(--accent)'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const score = context.raw;
                            let performance = '';
                            if (score <= 2.0) performance = ' (Excellent)';
                            else if (score <= 3.0) performance = ' (Good)';
                            else if (score <= 4.0) performance = ' (Average)';
                            else if (score <= 5.0) performance = ' (Below Average)';
                            else performance = ' (Poor)';
                            return `Average: ${score.toFixed(2)}${performance}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: 'var(--muted-text)' },
                    title: {
                        display: true,
                        text: 'Average Grade Score',
                        color: 'var(--muted-text)'
                    }
                },
                y: {
                    ticks: { color: 'var(--muted-text)' }
                }
            }
        }
    });
    
    window.subjectGradeChart = subjectGradeChart;
    window.subjectPerformanceChart = subjectPerformanceChart;
}

// Initialize subject charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (Object.keys(subjectData).length > 0) {
        initSubjectCharts();
    } else {
        document.getElementById('subjectGradeChart').getContext('2d').fillText(
            "No subject data available for {{ latest_exam }} {{ latest_year }}", 
            document.getElementById('subjectGradeChart').width / 2, 
            document.getElementById('subjectGradeChart').height / 2
        );
        document.getElementById('subjectPerformanceChart').getContext('2d').fillText(
            "No subject data available for {{ latest_exam }} {{ latest_year }}", 
            document.getElementById('subjectPerformanceChart').width / 2, 
            document.getElementById('subjectPerformanceChart').height / 2
        );
    }
    
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Full screen functionality for subject charts
function openSubjectChartFullscreen(chartId, modalId, title) {
    const chart = window[chartId];
    if (!chart) return;
    
    const modal = document.getElementById(modalId);
    const canvas = modal.querySelector('canvas');
    const titleElement = modal.querySelector('.fullscreen-title');
    
    titleElement.textContent = title.replace('Subject Grade Distribution', `Subject Grade Distribution ({{ latest_year }} {{ latest_exam }})`)
                                    .replace('Top Performing Subjects', `Top Performing Subjects ({{ latest_year }} {{ latest_exam }})`);
    modal.classList.add('active');
    
    const existingChart = Chart.getChart(canvas);
    if (existingChart) {
        existingChart.destroy();
    }
    
    const fullscreenChart = new Chart(canvas, {
        type: chart.config.type,
        data: JSON.parse(JSON.stringify(chart.config.data)),
        options: JSON.parse(JSON.stringify(chart.config.options))
    });
    
    fullscreenChart.options.maintainAspectRatio = false;
    fullscreenChart.options.plugins.title = {
        display: true,
        text: title.replace('Subject Grade Distribution', `Subject Grade Distribution ({{ latest_year }} {{ latest_exam }})`)
                   .replace('Top Performing Subjects', `Top Performing Subjects ({{ latest_year }} {{ latest_exam }})`),
        font: { size: 18 },
        color: 'var(--accent)'
    };
    fullscreenChart.update();
    
    modal.dataset.chartInstance = fullscreenChart;
}

// Close fullscreen modals
document.querySelectorAll('.close-fullscreen[data-modal]').forEach(btn => {
    btn.addEventListener('click', function() {
        const modalId = this.getAttribute('data-modal');
        const modal = document.getElementById(modalId);
        
        if (modal.dataset.chartInstance) {
            const chart = Chart.getChart(modal.querySelector('canvas'));
            if (chart) {
                chart.destroy();
            }
            delete modal.dataset.chartInstance;
        }
        
        modal.classList.remove('active');
    });
});

// Add fullscreen buttons to subject charts
document.querySelectorAll('.fullscreen-btn[data-chart="subjectGradeChart"]').forEach(btn => {
    btn.addEventListener('click', function() {
        openSubjectChartFullscreen('subjectGradeChart', 'fullscreenSubjectGradeModal', 'Subject Grade Distribution');
    });
});

document.querySelectorAll('.fullscreen-btn[data-chart="subjectPerformanceChart"]').forEach(btn => {
    btn.addEventListener('click', function() {
        openSubjectChartFullscreen('subjectPerformanceChart', 'fullscreenSubjectPerformanceModal', 'Top Performing Subjects');
    });
});

// Close modals when clicking outside or pressing Escape
document.querySelectorAll('.fullscreen-modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
            if (this.dataset.chartInstance) {
                const chart = Chart.getChart(this.querySelector('canvas'));
                if (chart) {
                    chart.destroy();
                }
                delete this.dataset.chartInstance;
            }
        }
    });
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.querySelectorAll('.fullscreen-modal').forEach(modal => {
            if (modal.classList.contains('active')) {
                modal.classList.remove('active');
                if (modal.dataset.chartInstance) {
                    const chart = Chart.getChart(modal.querySelector('canvas'));
                    if (chart) {
                        chart.destroy();
                    }
                    delete modal.dataset.chartInstance;
                }
            }
        });
    }
});
</script>
{% endblock %}